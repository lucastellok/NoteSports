<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Laranjal do Jari</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    Laranjal do Jari
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-home me-1"></i>
                                Início
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="quadras.html">
                                <i class="fas fa-running me-1"></i>
                                Quadras
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="reservas.html">
                                <i class="fas fa-calendar-check me-1"></i>
                                Reservas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="perfil.html">
                                <i class="fas fa-user me-1"></i>
                                Perfil
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 id="princ">
                    <i class="fas fa-cogs me-3"></i>
                    Painel Administrativo
                </h1>
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="court text-center">
                    <i class="fas fa-calendar-check fa-2x mb-2" style="color: var(--light-orange);"></i>
                    <h4 id="totalReservas">0</h4>
                    <p>Total de Reservas</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="court text-center">
                    <i class="fas fa-hourglass-half fa-2x mb-2 text-warning"></i>
                    <h4 id="reservasPendentes">0</h4>
                    <p>Pendentes</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="court text-center">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                    <h4 id="reservasAprovadas">0</h4>
                    <p>Aprovadas</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="court text-center">
                    <i class="fas fa-users fa-2x mb-2" style="color: var(--light-orange);"></i>
                    <h4 id="totalUsuarios">0</h4>
                    <p>Usuários Cadastrados</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="court">
                    <h3 class="mb-3">
                        <i class="fas fa-filter me-2"></i>
                        Filtros
                    </h3>
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <select class="form-select" id="filtroStatus">
                                <option value="">Todos os Status</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Aprovado">Aprovado</option>
                                <option value="Reprovado">Reprovado</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <input type="date" class="form-control" id="filtroData" placeholder="Filtrar por data">
                        </div>
                        <div class="col-md-3 mb-2">
                            <input type="text" class="form-control" id="filtroNome" placeholder="Buscar por nome">
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                                <i class="fas fa-search me-1"></i>
                                Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Reservas -->
        <div class="row">
            <div class="col-12">
                <div class="court">
                    <h3 class="mb-3">
                        <i class="fas fa-list me-2"></i>
                        Gerenciar Reservas
                    </h3>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-key me-1"></i>Código</th>
                                    <th><i class="fas fa-user me-1"></i>Nome</th>
                                    <th><i class="fas fa-phone me-1"></i>Telefone</th>
                                    <th><i class="fas fa-calendar me-1"></i>Data</th>
                                    <th><i class="fas fa-clock me-1"></i>Horário</th>
                                    <th><i class="fas fa-map-marker-alt me-1"></i>Local</th>
                                    <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                    <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="reservasTableBody">
                                <!-- Reservas carregadas dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quadras Mais Utilizadas -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="court">
                    <h3 class="mb-3">
                        <i class="fas fa-chart-bar me-2"></i>
                        Quadras Mais Utilizadas
                    </h3>
                    <div id="quadrasPopulares" class="row">
                        <!-- Carregado dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center mt-5">
        <p id="barra_baixo">
            <i class="fas fa-copyright me-1"></i>
            2024 Prefeitura do Laranjal do Jari. Todos os direitos reservados.
        </p>
    </footer>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirmar Ação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    <!-- Conteúdo dinâmico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmButton">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Reserva -->
    <div class="modal fade" id="detalhesModal" tabindex="-1" aria-labelledby="detalhesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesModalLabel">
                        <i class="fas fa-info-circle me-2"></i>
                        Detalhes da Reserva
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detalhesModalBody">
                    <!-- Conteúdo dinâmico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let todasReservas = [];
        let reservasFiltradas = [];

        // Carrega dados ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            carregarEstatisticas();
            carregarReservas();
        });

        async function carregarEstatisticas() {
            try {
                const response = await fetch(`${API_BASE}/estatisticas`);
                const stats = await response.json();
                
                document.getElementById('totalReservas').textContent = stats.total_reservas;
                document.getElementById('reservasPendentes').textContent = stats.reservas_por_status.Pendente || 0;
                document.getElementById('reservasAprovadas').textContent = stats.reservas_por_status.Aprovado || 0;
                document.getElementById('totalUsuarios').textContent = stats.total_usuarios;
                
                // Carrega quadras populares
                const container = document.getElementById('quadrasPopulares');
                container.innerHTML = '';
                
                stats.quadras_populares.forEach(quadra => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 mb-3';
                    col.innerHTML = `
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-trophy fa-2x mb-2" style="color: var(--light-orange);"></i>
                                <h5>${quadra.nome}</h5>
                                <p class="text-muted">${quadra.local}</p>
                                <h4 class="text-primary">${quadra.total_reservas}</h4>
                                <small>reservas</small>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        async function carregarReservas() {
            try {
                const response = await fetch(`${API_BASE}/admin/reservas`);
                todasReservas = await response.json();
                reservasFiltradas = [...todasReservas];
                renderizarTabela();
            } catch (error) {
                console.error('Erro ao carregar reservas:', error);
            }
        }

        function renderizarTabela() {
            const tbody = document.getElementById('reservasTableBody');
            tbody.innerHTML = '';

            if (reservasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhuma reserva encontrada</td></tr>';
                return;
            }

            reservasFiltradas.forEach(reserva => {
                const row = document.createElement('tr');
                
                // Status styling
                let statusClass = 'text-warning';
                let statusIcon = 'fas fa-hourglass-half';
                
                if (reserva.status === 'Aprovado') {
                    statusClass = 'text-success';
                    statusIcon = 'fas fa-check-circle';
                } else if (reserva.status === 'Reprovado') {
                    statusClass = 'text-danger';
                    statusIcon = 'fas fa-times-circle';
                }

                row.innerHTML = `
                    <td><strong class="text-primary">${reserva.codigo_unico}</strong></td>
                    <td>${reserva.nome_usuario}</td>
                    <td>${reserva.telefone}</td>
                    <td>${formatDate(reserva.data_reserva)}</td>
                    <td>${reserva.hora_inicio} - ${reserva.hora_fim}</td>
                    <td>${reserva.quadra_nome}<br><small class="text-muted">${reserva.local}</small></td>
                    <td><span class="${statusClass}"><i class="${statusIcon} me-1"></i>${reserva.status}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" onclick="verDetalhes(${reserva.id})" title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="atualizarStatus(${reserva.id}, 'Aprovado')" title="Aprovar">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="atualizarStatus(${reserva.id}, 'Pendente')" title="Pendente">
                                <i class="fas fa-clock"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="atualizarStatus(${reserva.id}, 'Reprovado')" title="Reprovar">
                                <i class="fas fa-times"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirReserva(${reserva.id})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function aplicarFiltros() {
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroData = document.getElementById('filtroData').value;
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();

            reservasFiltradas = todasReservas.filter(reserva => {
                let passa = true;
                
                if (filtroStatus && reserva.status !== filtroStatus) {
                    passa = false;
                }
                
                if (filtroData && reserva.data_reserva !== filtroData) {
                    passa = false;
                }
                
                if (filtroNome && !reserva.nome_usuario.toLowerCase().includes(filtroNome)) {
                    passa = false;
                }
                
                return passa;
            });

            renderizarTabela();
        }

        function verDetalhes(reservaId) {
            const reserva = todasReservas.find(r => r.id === reservaId);
            if (!reserva) return;

            const modalBody = document.getElementById('detalhesModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-key me-1"></i> Código da Reserva</h6>
                        <p class="text-primary fw-bold">${reserva.codigo_unico}</p>
                        
                        <h6><i class="fas fa-user me-1"></i> Nome do Usuário</h6>
                        <p>${reserva.nome_usuario}</p>
                        
                        <h6><i class="fas fa-phone me-1"></i> Telefone</h6>
                        <p>${reserva.telefone}</p>
                        
                        <h6><i class="fas fa-calendar me-1"></i> Data da Reserva</h6>
                        <p>${formatDate(reserva.data_reserva)}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-clock me-1"></i> Horário</h6>
                        <p>${reserva.hora_inicio} - ${reserva.hora_fim}</p>
                        
                        <h6><i class="fas fa-map-marker-alt me-1"></i> Local</h6>
                        <p>${reserva.quadra_nome}<br><small class="text-muted">${reserva.local}</small></p>
                        
                        <h6><i class="fas fa-info-circle me-1"></i> Status</h6>
                        <p><span class="badge bg-${reserva.status === 'Aprovado' ? 'success' : reserva.status === 'Reprovado' ? 'danger' : 'warning'}">${reserva.status}</span></p>
                        
                        <h6><i class="fas fa-calendar-plus me-1"></i> Solicitado em</h6>
                        <p>${formatDateTime(reserva.created_at)}</p>
                    </div>
                </div>
                ${reserva.observacoes ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="fas fa-comment me-1"></i> Observações</h6>
                            <p class="bg-light p-2 rounded">${reserva.observacoes}</p>
                        </div>
                    </div>
                ` : ''}
            `;

            const modal = new bootstrap.Modal(document.getElementById('detalhesModal'));
            modal.show();
        }

        function atualizarStatus(reservaId, novoStatus) {
            const reserva = todasReservas.find(r => r.id === reservaId);
            if (!reserva) return;

            const modalBody = document.getElementById('confirmModalBody');
            modalBody.innerHTML = `
                <p>Deseja alterar o status da reserva <strong>${reserva.codigo_unico}</strong> de <strong>${reserva.status}</strong> para <strong>${novoStatus}</strong>?</p>
                <p><strong>Usuário:</strong> ${reserva.nome_usuario}</p>
                <p><strong>Data/Horário:</strong> ${formatDate(reserva.data_reserva)} às ${reserva.hora_inicio}</p>
            `;

            const confirmButton = document.getElementById('confirmButton');
            confirmButton.onclick = async () => {
                try {
                    const response = await fetch(`${API_BASE}/admin/atualizar-status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            reserva_id: reservaId,
                            status: novoStatus
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
                        carregarReservas();
                        carregarEstatisticas();
                    } else {
                        alert('Erro ao atualizar status: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status');
                }
            };

            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        function excluirReserva(reservaId) {
            const reserva = todasReservas.find(r => r.id === reservaId);
            if (!reserva) return;

            const modalBody = document.getElementById('confirmModalBody');
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atenção!</strong> Esta ação não pode ser desfeita.
                </div>
                <p>Deseja realmente excluir a reserva <strong>${reserva.codigo_unico}</strong>?</p>
                <p><strong>Usuário:</strong> ${reserva.nome_usuario}</p>
                <p><strong>Data/Horário:</strong> ${formatDate(reserva.data_reserva)} às ${reserva.hora_inicio}</p>
            `;

            const confirmButton = document.getElementById('confirmButton');
            confirmButton.className = 'btn btn-danger';
            confirmButton.innerHTML = '<i class="fas fa-trash me-1"></i>Excluir';
            
            confirmButton.onclick = async () => {
                try {
                    const response = await fetch(`${API_BASE}/admin/excluir-reserva?id=${reservaId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
                        carregarReservas();
                        carregarEstatisticas();
                    } else {
                        alert('Erro ao excluir reserva: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao excluir reserva:', error);
                    alert('Erro ao excluir reserva');
                }
            };

            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('pt-BR');
        }

        // Atualiza dados a cada 30 segundos
        setInterval(() => {
            carregarEstatisticas();
            carregarReservas();
        }, 30000);
    </script>
</body>
</html>
